<!DOCTYPE html>
<html lang="fr" xml:lang="fr">
<head>
  <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
  <title>CountDown</title>
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300"></link>
  <link rel="stylesheet" href="jquery.countdown.css"></link>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="cookies.js"></script>
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
<body>
  <form>
    <input id="date" type="date" name="myDate" title="Date (jj-mm-aaaa)"
    value="2012-10-10"
    required="required" autofocus="autofocus" />
    <input id="time" type="time" name="myTime" title="Time (hh:mn)" value="14:30"
    required="required" placeholder="08:15" step="15" />
    <input id="btnStart" type="button" value="Lancer" />
    <input id="btnStop" type="button" value="Arreter" />
  </form>
  <span id="formDisplay" style="cursor:pointer;">&#x2191;</span>
  <div id="countdown" style="display:none;">
    <p style="text-align:center;">Fin du sprint dans :</p>
  </div>
</body>
<script type="text/javascript">
  var debug = false;
  var deadline, timeoutId, positions;
  var minute = 60;
  var hour = minute * 60;
  var day = hour * 24;
  var week = day * 7;
  var classStatic = 'digit';

  var options = {
    'Weeks': '<span class="separator" style="width:120px;">semaines</span>',
    'Days': '<span class="separator" style="width:68px;">jours</span>',
    'Hours': '<span class="countDiv countDiv1"></span>',
    'Minutes': '<span class="countDiv countDiv2"></span>',
  };

  function init(elem, options)
  {
    elem.addClass('countdownHolder');

    // Creating the markup inside the container
    $.each(['Weeks', 'Days','Hours','Minutes','Seconds'],function(i){
      $('<span class="count'+this+'">').html(
        '<span class="position">\
          <span class="digit static">0</span>\
        </span>\
        <span class="position">\
          <span class="digit static">0</span>\
        </span>'
      ).appendTo(elem);

      if (options[this] != undefined) {
        elem.append(options[this]);
      }
    });
    positions = elem.find('.position');
  }

  function updateDuo(minor,major,value){
    switchDigit(positions.eq(minor),Math.floor(value/10)%10);
    switchDigit(positions.eq(major),value%10);
  }

  // Creates an animated transition between the two numbers
  function switchDigit(position, number) {

    var digit = position.find('.digit');
    if (digit.length < 1) {
      digit = position.find('.'+classStatic);
    }

    if (digit.is(':animated') || position.data('digit') == number) {
      return false;
    }

    position.data('digit', number);

    var replacement = $('<span>',{
      'class': classStatic,
      css:{
        top:'-2.1em',
        opacity:0
      },
      html:number
    });

    // The .static class is added when the animation
    // completes. This makes it run smoother.

    digit
      .before(replacement)
      .removeClass('static')
      .animate({top:'2.5em',opacity:0},'fast',function(){
        digit.remove();
      });

    replacement
      .delay(100)
      .animate({top:0,opacity:1},'fast',function(){
        replacement.addClass('static');
    });
    //replacement = digit = null;
  }

  $('#formDisplay').click(function(event) {
    var $form = $(document.forms[0]);
    if ($form.is(':hidden')) {
      $form.css('display', 'inline');
      $(this).html('&#x2191;');
    } else {
      $form.hide();
      $(this).html('&#x2193;');
    }
    $form = null;
  });

  init($('#countdown'), options);

  if (allCookies.hasItem('deadline')) {
    deadline = new Date(allCookies.getItem('deadline'));
    $('#formDisplay').trigger('click');
    $('#countdown').show();
    countdown();
  }

  $('#btnStart').click(function(event) {
      event.preventDefault();
      deadline = new Date($('#date').val().replace(/-/g, '/') + ' ' + $('#time').val());
      if (debug) console.log(deadline);
      allCookies.setItem('deadline', deadline.toString(), Infinity);
      if (debug) console.log(allCookies.hasItem('deadline'));
      if (debug) console.log('cookie: '+allCookies.getItem('deadline'));
      var $countdown = $('#countdown');
      if ($('#countdown span').length < 1) {
        init($countdown, options);
      }
      $countdown.show();
      $('#formDisplay').trigger('click');
      countdown();
  });

  $('#btnStop').click(function(event) {
      event.preventDefault();
      window.clearTimeout(timeoutId);
      allCookies.removeItem('deadline');
      $('#countdown').hide();
      $('#countdown span').remove();
      positions = null;
  });

  function countdown() {
    var left = (deadline.getTime() - Date.now()) / 1000;
    var nbWeeks, nbDays, nbHours, nbMinutes;

    if (left < 0) {
      left = 0;
    } else if (classStatic == 'digit' && left < hour) {
      classStatic = 'digitRed';
      $('span.digit').removeClass('digit').addClass(classStatic);
    } else if (classStatic != 'digit' && left > hour) {
      classStatic = 'digit';
      $('span.'+classStatic).removeClass(classStatic).addClass('digit');
    }

    nbWeeks = Math.floor(left / week);
    updateDuo(0, 1, nbWeeks);
    left -= nbWeeks * week;

    nbDays = Math.floor(left / day);
    updateDuo(2, 3, nbDays);
    left -= nbDays * day;

    nbHours = Math.floor(left / hour);
    updateDuo(4, 5, nbHours);
    left -= nbHours * hour;

    nbMinutes = Math.floor(left / minute);
    updateDuo(6, 7, nbMinutes);
    left -= nbMinutes * minute;
    updateDuo(8, 9, Math.floor(left));

    nbWeeks = nbDays = nbHours = nbMinutes = null;

    if (left > 0) {
      left = null;
      timeoutId = setTimeout(countdown, 1000);
    }
  }
</script>
</html>
